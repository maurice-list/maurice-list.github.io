<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Level Detail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Lexend+Deca' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css2?family=Montserrat' rel='stylesheet'>
    <link rel="icon" href="/resources/icons/maurice.png">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1908323352197629"
     crossorigin="anonymous"></script>
    <script>if (document.cookie.includes('darkMode=1')) document.documentElement.classList.add('dark');</script>
    <style>
      :root {
          --bg:         #ffffff;
          --text:       #000000;
          --text-sub:   #555555;
          --link:       blue;
          --border:     #ddd;
          --table-head: #f2f2f2;
      }
      html.dark body {
          --bg:           #1e1e1e;
          --text:         #e0e0e0;
          --text-sub:     #aaaaaa;
          --link:         #7eb8f7;
          --border:       #555555;
          --table-head:   #2a2a2a;
      }
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
        background-color: var(--bg);
        color: var(--text);
        transition: background-color 0.3s, color 0.3s;
      }
      a { color: var(--link); }
      table { border-color: var(--border); width: 100%; }
      th, td { border-color: var(--border) !important; }
      th { background-color: var(--table-head) !important; color: var(--text); }
      td { color: var(--text); }
      .level-detail {
        max-width: 660px;
        margin: 50px auto;
      }
      .back-link {
        margin-top: 20px;
        display: inline-block;
        font-size: 16px;
        color: var(--link);
        text-decoration: none;
      }
      .back-link:hover {
        text-decoration: underline;
      }
      .video-wrapper {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        margin: 16px 0;
      }
      .video-wrapper iframe {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        border: none;
      }
      .table-scroll {
        width: 100%;
        overflow-x: auto;
      }
      #dark-toggle {
          position: fixed;
          top: 14px;
          right: 18px;
          background: none;
          border: 2px solid var(--text);
          border-radius: 20px;
          padding: 4px 12px;
          font-size: 20px;
          cursor: pointer;
          color: var(--text);
          transition: border-color 0.3s, color 0.3s;
          z-index: 999;
      }
      @media (max-width: 600px) {
        body { margin: 12px; }
        .level-detail { margin: 40px auto; }
      }
    </style>
  </head>
  <body>
    <button id="dark-toggle" onclick="toggleDark()" title="Toggle dark mode">üåô</button>
    <script>
      function applyDark(dark) {
          document.documentElement.classList.toggle('dark', dark);
          document.getElementById('dark-toggle').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
      }
      function toggleDark() {
          const isDark = !document.documentElement.classList.contains('dark');
          document.cookie = 'darkMode=' + (isDark ? '1' : '0') + '; path=/; max-age=31536000';
          applyDark(isDark);
      }
      applyDark(document.documentElement.classList.contains('dark'));
    </script>
    <div id="level-detail" class="level-detail">Loading level details...</div>
    <script>
      const detailContainer = document.getElementById("level-detail");
      const params = new URLSearchParams(window.location.search);
      const placementParam = params.get("placement");

      if (!placementParam) {
        detailContainer.innerText = "No placement parameter provided.";
      } else {
        const placement = parseInt(placementParam, 10);
        if (isNaN(placement) || placement < 1) {
          detailContainer.innerText = "Invalid placement parameter.";
        } else {
          Promise.all([
            fetch("/resources/data/users.json").then(r => r.json()),
            fetch("/resources/data/levels.json").then(r => r.json()),
            fetch("/resources/data/changelog.json").then(r => r.json())
          ])
          .then(([userMap, levelIds, changelogData]) => {
            return Promise.all(
              levelIds.map(id =>
                fetch(`/resources/data/levels/${id}.json`)
                  .then(resp => resp.json())
                  .catch(error => {
                    console.error(`Error loading level ${id}:`, error);
                    return null;
                  })
              )
            ).then(levels => ({ userMap, levelIds, levels, changelogData }));
          })
          .then(({ userMap, levelIds, levels, changelogData }) => {
            const validLevels = levels.filter(level => level !== null);
            if (placement > validLevels.length) {
              detailContainer.innerText = "Level not found.";
              return;
            }
            const level = validLevels[placement - 1];
            const fileId = levelIds[placement - 1];

            const prevPlacement = placement > 1 ? placement - 1 : null;
            const nextPlacement = placement < validLevels.length ? placement + 1 : null;

            document.title = `#${placement} - ${level.name}`;

            const historyEntries = changelogData.filter(entry => entry.name === fileId);

            let historyHtml = "";
            if (historyEntries.length > 0) {
              historyHtml = `
                <h2 style="font-family: Calibri">Position History</h2>
                <a href="#" onclick="togglePositionHistory(); return false;">(Click to expand/collapse)</a>
                <div id="position-history" style="display: none; margin-top: 10px;">
                  <div class="table-scroll">
                  <table border="1" cellpadding="8" cellspacing="0">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Old Position</th>
                        <th>New Position</th>
                        <th>Reason</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              historyEntries.forEach(h => {
                historyHtml += `
                      <tr>
                        <td>${new Date(Number(h.date * 1000)).toLocaleDateString()}</td>
                        <td>${h.from_rank ? h.from_rank : "-"}</td>
                        <td>${h.to_rank}</td>
                        <td>${h.reason}</td>
                      </tr>
                `;
              });
              historyHtml += `
                    </tbody>
                  </table>
                  </div>
                </div>
              `;
            } else {
              historyHtml = `<h2 style="font-family: Calibri">Position History</h2><p>No history found.</p>`;
            }

            let recordsHtml = "";
            if (level.records && level.records.length > 0) {
              recordsHtml = `
                <h2>Records</h2>
                <div class="table-scroll">
                <table border="1" cellpadding="8" cellspacing="0">
                  <thead>
                    <tr>
                      <th>Record Holder</th>
                      <th>Progress</th>
                      <th>Video Proof</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              level.records.forEach(record => {
                const userName = userMap[record.user] || record.user;
                recordsHtml += `
                    <tr>
                      <td>${userName}</td>
                      <td>${record.percent}%</td>
                      <td><a href="https://youtu.be/${record.link}" target="_blank">Proof</a></td>
                    </tr>
                `;
              });
              recordsHtml += `
                  </tbody>
                </table>
                </div>
              `;
            } else {
              recordsHtml = `<h2>Records</h2><p>No records yet!</p>`;
            }

            const listPoints = calculatePoints(placement, validLevels.length);

            detailContainer.innerHTML = `
              <h1 style="font-family: 'Montserrat'; font-size: clamp(22px, 5vw, 36px);">
                ${prevPlacement ? `<a href="?placement=${prevPlacement}" style="text-decoration: none;">‚¨Ö</a>` : ""}
                #${placement} - ${level.name}
                ${nextPlacement ? `<a href="?placement=${nextPlacement}" style="text-decoration: none;">‚û°</a>` : ""}
              </h1>
              <p style="font-family: 'Montserrat'; font-size: clamp(14px, 3vw, 18px);">
                by ${userMap[level.creators[0]] || level.creators[0]}, verified by ${userMap[level.verifier] || level.verifier}
              </p>
              <div class="video-wrapper">
                <iframe
                        src="https://www.youtube.com/embed/${level.verification}?rel=0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                </iframe>
              </div>
              <div style="margin-top: 20px; font-family: 'Montserrat'; font-size: clamp(14px, 3vw, 18px); display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="text-align: center;">
                  <p><strong>List Points</strong></p>
                  <p>${listPoints}</p>
                </div>
                <div style="text-align: center;">
                  <p><strong>Level ID</strong></p>
                  <p><a href="https://gdbrowser.com/${level.id}" target="_blank" style="text-decoration: none;">${level.id}</a></p>
                </div>
                <div style="text-align: center;">
                  <p><strong>Song ID</strong></p>
                  <p><a href="https://www.newgrounds.com/audio/listen/${level.song}" target="_blank" style="text-decoration: none;">${level.song || "N/A"}</a></p>
                </div>
              </div>
              ${historyHtml}
              ${recordsHtml}
              <a class="back-link" href="../">Back to list</a>
            `;
          })
          .catch(error => {
            console.error("Error fetching data:", error);
            detailContainer.innerText = "Error loading level details.";
          });
        }
      }

      function togglePositionHistory() {
        const ph = document.getElementById('position-history');
        ph.style.display = (ph.style.display === 'none') ? 'block' : 'none';
      }

      function calculatePoints(placement, totalLevels, topPoints = 100, bottomPoints = 50) {
        const range = Math.log(totalLevels);
        const logPlacement = Math.log(placement);
        const normalized = logPlacement / range;
        return Math.round(topPoints - normalized * (topPoints - bottomPoints));
      }
    </script>
  </body>
</html>
