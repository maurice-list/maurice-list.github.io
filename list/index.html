<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Level Detail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Lexend+Deca' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css2?family=Montserrat' rel='stylesheet'>
    <link rel="icon" href="/resources/icons/maurice.png">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1908323352197629"
     crossorigin="anonymous"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }
      .level-detail {
        max-width: 600px;
        margin: 50px auto;
      }
      .back-link {
        margin-top: 20px;
        display: inline-block;
        font-size: 16px;
        color: blue;
        text-decoration: none;
      }
      .back-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="level-detail" class="level-detail">Loading level details...</div>
    <script>
      const detailContainer = document.getElementById("level-detail");
      const params = new URLSearchParams(window.location.search);
      const placementParam = params.get("placement");

      if (!placementParam) {
        detailContainer.innerText = "No placement parameter provided.";
      } else {
        const placement = parseInt(placementParam, 10);
        if (isNaN(placement) || placement < 1) {
          detailContainer.innerText = "Invalid placement parameter.";
        } else {
          Promise.all([
            fetch("/resources/data/users.json").then(r => r.json()),
            fetch("/resources/data/levels.json").then(r => r.json()),
            fetch("/resources/data/changelog.json").then(r => r.json())
          ])
          .then(([userMap, levelIds, changelogData]) => {
            return Promise.all(
              levelIds.map(id =>
                fetch(`/resources/data/levels/${id}.json`)
                  .then(resp => resp.json())
                  .catch(error => {
                    console.error(`Error loading level ${id}:`, error);
                    return null;
                  })
              )
            ).then(levels => ({ userMap, levelIds, levels, changelogData }));
          })
          .then(({ userMap, levelIds, levels, changelogData }) => {
            const validLevels = levels.filter(level => level !== null);
            if (placement > validLevels.length) {
              detailContainer.innerText = "Level not found.";
              return;
            }
            const level = validLevels[placement - 1];
            const fileId = levelIds[placement - 1];

            // Determine navigation links
            const prevPlacement = placement > 1 ? placement - 1 : null;
            const nextPlacement = placement < validLevels.length ? placement + 1 : null;

            // Update the document title with the level name:
            document.title = `#${placement} - ${level.name}`;

            const historyEntries = changelogData.filter(entry => entry.name === fileId);

            // Build "Position History" HTML
            let historyHtml = "";
            if (historyEntries.length > 0) {
              historyHtml = `
                <h2 style="font-family: Calibri">Position History</h2>
                <a href="#" onclick="togglePositionHistory(); return false;">(Click to expand/collapse)</a>
                <div id="position-history" style="display: none; margin-top: 10px;">
                  <table style="width: 640px;" border="1" cellpadding="8" cellspacing="0">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Old Position</th>
                        <th>New Position</th>
                        <th>Reason</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              historyEntries.forEach(h => {
                historyHtml += `
                      <tr>
                        <td>${new Date(Number(h.date * 1000)).toLocaleDateString()}</td>
                        <td>${h.from_rank ? h.from_rank : "-"}</td>
                        <td>${h.to_rank}</td>
                        <td>${h.reason}</td>
                      </tr>
                `;
              });
              historyHtml += `
                    </tbody>
                  </table>
                </div>
              `;
            } else {
              historyHtml = `<h2 style="font-family: Calibri">Position History</h2><p>No history found.</p>`;
            }

            // Build "Records" table or "No records yet!"
            let recordsHtml = "";
            if (level.records && level.records.length > 0) {
              recordsHtml = `
                <h2>Records</h2>
                <table style="width: 640px;" border="1" cellpadding="8" cellspacing="0">
                  <thead>
                    <tr>
                      <th>Record Holder</th>
                      <th>Progress</th>
                      <th>Video Proof</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              level.records.forEach(record => {
                const userName = userMap[record.user] || record.user;
                recordsHtml += `
                    <tr>
                      <td>${userName}</td>
                      <td>${record.percent}%</td>
                      <td><a href="https://youtu.be/${record.link}" target="_blank">Proof</a></td>
                    </tr>
                `;
              });
              recordsHtml += `
                  </tbody>
                </table>
              `;
            } else {
              recordsHtml = `<h2>Records</h2><p>No records yet!</p>`;
            }

            // Calculate list points dynamically
            const listPoints = calculatePoints(placement, validLevels.length);

            // Render final HTML with navigation arrows
            detailContainer.innerHTML = `
              <h1 style="font-family: 'Montserrat'; font-size: 36px;">
                ${prevPlacement ? `<a href="?placement=${prevPlacement}" style="text-decoration: none;">⬅</a>` : ""}
                #${placement} - ${level.name}
                ${nextPlacement ? `<a href="?placement=${nextPlacement}" style="text-decoration: none;">➡</a>` : ""}
              </h1>
              <p style="font-family: 'Montserrat'; font-size: 18px;">
                by ${userMap[level.creators[0]] || level.creators[0]}, verified by ${userMap[level.verifier] || level.verifier}
              </p>
              <div class="video-container">
                <iframe width="640" height="360"
                        src="https://www.youtube.com/embed/${level.verification}?rel=0"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                </iframe>
              </div>
              <div style="margin-top: 20px; font-family: 'Montserrat'; font-size: 18px; display: flex; justify-content: center; gap: 20px;">
                <div style="text-align: center;">
                  <p><strong>List Points</strong></p>
                  <p>${listPoints}</p>
                </div>
                <div style="text-align: center;">
                  <p><strong>Level ID</strong></p>
                  <p><a href="https://gdbrowser.com/${level.id}" target="_blank" style="text-decoration: none; color: blue;">${level.id}</a></p>
                </div>
                <div style="text-align: center;">
                  <p><strong>Song ID</strong></p>
                  <p><a href="https://www.newgrounds.com/audio/listen/${level.song}" target="_blank" style="text-decoration: none; color: blue;">${level.song || "N/A"}</a></p>
                </div>
              </div>
              ${historyHtml}
              ${recordsHtml}
              <a class="back-link" href="../">Back to list</a>
            `;
          })
          .catch(error => {
            console.error("Error fetching data:", error);
            detailContainer.innerText = "Error loading level details.";
          });
        }
      }

      // Simple toggle function for the position history
      function togglePositionHistory() {
        const ph = document.getElementById('position-history');
        ph.style.display = (ph.style.display === 'none') ? 'block' : 'none';
      }

      // Function to calculate points based on placement
      function calculatePoints(placement, totalLevels, topPoints = 100, bottomPoints = 50) {
        const range = Math.log(totalLevels); // Logarithmic range
        const logPlacement = Math.log(placement); // Logarithmic placement
        const normalized = logPlacement / range; // Normalize placement to [0, 1]
        return Math.round(topPoints - normalized * (topPoints - bottomPoints));
      }
    </script>
  </body>
</html>
